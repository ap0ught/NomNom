name: Generate Badges

on:
  schedule:
    - cron: '0 0 * * *'  # daily at midnight
  workflow_dispatch:

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup (Python)
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.x'

#       - name: Dependencies
#         run: pip install requests

#       - name: Generate
#         run: python ./.github/workflows/scripts/generate_download_badges.py

#       - name: Deploy
#         uses: peaceiris/actions-gh-pages@v4
#         with:
#           github_token: ${{ secrets.GITHUB_TOKEN }}
#           publish_dir: ./badges
#           destination_dir: badges

# # Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# # However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
# concurrency:
#   group: "pages"
#   cancel-in-progress: false

# jobs:
#   # Build job
#   build:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup (Pages)
#         uses: actions/configure-pages@v5

#       - name: Setup (Python)
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.x'

#       - name: Dependencies
#         run: pip install numerize requests

#       - name: Generate
#         run: python ./.github/workflows/scripts/generate_downloads_badges.py

#       - name: Upload artifact
#         uses: actions/upload-pages-artifact@v3
#         with:
#           path: ./output/

jobs:
  generate-badges:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache
        uses: actions/cache@v4
        with:
          path: site/badges
          key: badge-json-${{ hashFiles('.github/workflows/scripts/generate_downloads_badges.py') }}
          restore-keys: badge-json-

      - name: Setup (Python)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Dependencies
        run: pip install numerize requests

      - name: Generate
        run: python .github/workflows/scripts/generate_downloads_badges.py

      - name: Detect
        run: |
          if git diff --quiet site/badges; then
            echo "skip_deploy=true" >> $GITHUB_ENV
          else
            echo "skip_deploy=false" >> $GITHUB_ENV

      - name: Upload
        if: env.skip_deploy != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pages-badges
          path: site/badges/
